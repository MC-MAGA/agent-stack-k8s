steps:
  - label: ":memory: Resource Class Test"
    agents:
      queue: "{{.queue}}"
      resource_class: "test"
    image: alpine:latest
    command: |-
      echo "=== Memory Limit Check ==="
      # Check memory limit from cgroup v1 or v2
      if [ -f /sys/fs/cgroup/memory/memory.limit_in_bytes ]; then
        # cgroup v1
        MEMORY_LIMIT=$$(cat /sys/fs/cgroup/memory/memory.limit_in_bytes)
      elif [ -f /sys/fs/cgroup/memory.max ]; then
        # cgroup v2
        MEMORY_LIMIT=$$(cat /sys/fs/cgroup/memory.max)
      else
        echo "Could not find memory limit file"
        exit 1
      fi

      echo "Memory limit: $$MEMORY_LIMIT bytes"

      # Convert to MB for easier comparison (512Mi = 536870912 bytes)
      MEMORY_LIMIT_MB=$$((MEMORY_LIMIT / 1024 / 1024))
      echo "Memory limit: $${MEMORY_LIMIT_MB}MB"

      # Check if memory limit is approximately 512MB (allowing some variance)
      # We expect 512Mi which is 536870912 bytes = 512MB
      if [ "$$MEMORY_LIMIT_MB" -ge 500 ] && [ "$$MEMORY_LIMIT_MB" -le 550 ]; then
        echo "✅ Memory limit is correctly set to ~512MB"
      else
        echo "❌ Memory limit is not as expected. Got $${MEMORY_LIMIT_MB}MB, expected ~512MB"
        exit 1
      fi

      echo "=== CPU Limit Check ==="
      # Check CPU limit from cgroup
      if [ -f /sys/fs/cgroup/cpu/cpu.cfs_quota_us ] && [ -f /sys/fs/cgroup/cpu/cpu.cfs_period_us ]; then
        # cgroup v1
        CPU_QUOTA=$$(cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us)
        CPU_PERIOD=$$(cat /sys/fs/cgroup/cpu/cpu.cfs_period_us)
      elif [ -f /sys/fs/cgroup/cpu.max ]; then
        # cgroup v2
        CPU_MAX=$$(cat /sys/fs/cgroup/cpu.max)
        CPU_QUOTA=$$(echo $$CPU_MAX | cut -d' ' -f1)
        CPU_PERIOD=$$(echo $$CPU_MAX | cut -d' ' -f2)
      else
        echo "Could not find CPU limit files"
        exit 1
      fi

      if [ "$$CPU_QUOTA" != "-1" ] && [ "$$CPU_QUOTA" != "max" ]; then
        CPU_CORES=$$((CPU_QUOTA * 1000 / CPU_PERIOD))
        echo "CPU quota: $${CPU_QUOTA}, CPU period: $${CPU_PERIOD}"
        echo "CPU limit: $${CPU_CORES}m cores"

        # Check if CPU limit is approximately 500m (allowing some variance)
        if [ "$$CPU_CORES" -ge 450 ] && [ "$$CPU_CORES" -le 550 ]; then
          echo "✅ CPU limit is correctly set to ~500m"
        else
          echo "❌ CPU limit is not as expected. Got $${CPU_CORES}m, expected ~500m"
          exit 1
        fi
      else
        echo "❌ No CPU limit set"
        exit 1
      fi
